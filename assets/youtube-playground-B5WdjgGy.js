var T=Object.defineProperty;var P=(s,e,t)=>e in s?T(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var m=(s,e,t)=>P(s,typeof e!="symbol"?e+"":e,t);import{u as p,q as k,d as _,e as C,r as g,o as d,c as y,w as x,v as O,g as S,F as B,p as D,n as R,s as Y,x as V,t as I}from"./index-HEIN1-Z_.js";function E(s){return typeof s=="function"?s():p(s)}typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;const b=()=>{};function W(s,e){function t(...a){return new Promise((o,i)=>{Promise.resolve(s(()=>e.apply(this,a),{fn:e,thisArg:this,args:a})).then(o).catch(i)})}return t}function z(s,e={}){let t,a,o=b;const i=c=>{clearTimeout(c),o(),o=b};return c=>{const f=E(s),h=E(e.maxWait);return t&&i(t),f<=0||h!==void 0&&h<=0?(a&&(i(a),a=null),Promise.resolve(c())):new Promise((n,r)=>{o=e.rejectOnCancel?r:n,h&&!a&&(a=setTimeout(()=>{t&&i(t),a=null,n(c())},h)),t=setTimeout(()=>{a&&i(a),a=null,n(c())},f)})}}function F(s,e=200,t={}){return W(z(e,t),s)}async function N(s,e){return new Promise((t,a)=>{const o=new Date().valueOf(),i=setInterval(()=>{s()?(clearInterval(i),t()):new Date().valueOf()-o.valueOf()>e&&(clearInterval(i),a())},20)})}const $={lazy:!0,initOnCreate:!0};class A{constructor(e,t,a){m(this,"state");m(this,"initOnCreate");m(this,"pauseWhileBufferingErrorEncountered");const o={...$,...a},i=k({videoId:e,elementId:t,lazy:o.lazy,player:null,mountingState:0,playerState:0,currentTime:0,progressInterval:0});this.state=i,this.initOnCreate=o.initOnCreate,this.pauseWhileBufferingErrorEncountered=!1,e&&t?this.initOnCreate&&this.init():console.error("Error, incorrect construction parameters for audio player.")}async init(){if(!await this.checkSourceValidity()){console.error(`[Error] :: Invalid source for track ${this.state.videoId}.`);return}if(!document.getElementById(this.state.elementId)){console.error(`[Error] :: element does not exist ${this.state.elementId}.`);return}this.state.mountingState=1,this.state.player=new YT.Player(this.state.elementId,{height:"0",width:"0",videoId:this.state.videoId,playerVars:{autoplay:0,playlist:this.state.videoId,enablejsapi:1,origin:window.location.origin},events:{onReady:()=>this.onPlayerReady(),onStateChange:e=>this.onPlayerStateChange(e),onError:e=>this.onPlayerError(e)}})}async recreateIframe(){if(this.state.playerState===1){this.pause();try{await N(()=>this.state.playerState!==1,5e3)}catch{console.error("[ERROR] player.recreateIframe() :: 5s timeout to reacreate IFrame reached");return}}const e=document.getElementById(this.state.elementId),t=document.createElement("div");t.setAttribute("id",this.state.elementId),t.classList.add("hidden"),this.state.mountingState=0,e==null||e.replaceWith(t),this.init()}onPlayerReady(){var e,t,a;this.state.mountingState=2,(e=this.state.player)==null||e.setPlaybackQuality("small"),(t=this.state.player)==null||t.setVolume(100),this.state.lazy||this.play(),(a=this.state.player)!=null&&a.getDuration()}onPlayerStateChange(e){var t,a,o;switch(e.data){case YT.PlayerState.BUFFERING:this.state.playerState=1;break;case YT.PlayerState.PLAYING:this.state.mountingState===2&&((t=this.state.player)==null?void 0:t.getCurrentTime())!==this.state.currentTime&&((a=this.state.player)==null||a.seekTo(this.state.currentTime,!0)),this.state.mountingState=3,this.state.playerState=1,this.state.lazy||(this.state.lazy=!0),this.state.progressInterval=window.setInterval(()=>{var i;this.state.mountingState>=2&&(this.state.currentTime=Math.round(((i=this.state.player)==null?void 0:i.getCurrentTime())??0))},500),this.pauseWhileBufferingErrorEncountered&&this.pause();break;case YT.PlayerState.PAUSED:this.state.playerState=0,window.clearInterval(this.state.progressInterval);break;case YT.PlayerState.ENDED:this.state.playerState=0,window.clearInterval(this.state.progressInterval),(o=this.state.player)==null||o.seekTo(0,!0);break}}onPlayerError(e){var t,a;[((t=YT.PlayerError)==null?void 0:t.EmbeddingNotAllowed)??"101",((a=YT.PlayerError)==null?void 0:a.EmbeddingNotAllowed2)??"150"].includes(e.data)?this.recreateIframe():console.error("[ERROR] :: unexpected YT player error",e.data)}play(){var e;this.state.mountingState===0?this.init():this.state.mountingState===1?this.state.lazy=!1:(e=this.state.player)==null||e.playVideo()}pause(){var e;this.pauseWhileBufferingErrorEncountered=!1,this.state.mountingState===1?this.state.lazy=!0:this.state.mountingState===2?this.pauseWhileBufferingErrorEncountered=!0:this.state.mountingState===3&&((e=this.state.player)==null||e.pauseVideo())}destroy(){var e,t;window.clearInterval(this.state.progressInterval),(e=this.state.player)==null||e.destroy(),(t=document.getElementById(this.state.elementId))==null||t.remove()}async checkSourceValidity(){try{const e=await fetch(`https://www.youtube.com/oembed?url=https://youtube.com/watch?v=${this.state.videoId}&format=json`);if(!(e!=null&&e.ok))throw e;return!0}catch(e){return console.error(e),!1}}}const G={class:"flex flex-col gap-3"},j=S("h2",{class:"text-xl font-bold"},"Youtube Playground",-1),L=["disabled"],U={key:0},q={key:1},M={key:2},Q=["url","onClick"],H=["id"],Z=_({__name:"youtube-playground",setup(s){const e=C(),t=g(""),a=g(""),o=g(!1),i=g([]),v=F(async()=>{var n;c(),o.value=!0;try{const r=await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&key=${(n=e.userSession)==null?void 0:n.idClient}&q=${t.value}`);i.value=(await r.json()).items.map(u=>({...u.snippet,...u.id})),R(f)}catch(r){console.error(r),a.value=r}finally{o.value=!1}},1e3);function c(){i.value.forEach(n=>{var r;(r=n.player)==null||r.destroy()})}function f(){i.value.forEach(n=>{var r;(r=n.player)==null||r.destroy(),n.player=new A(n.videoId,n.videoId)})}function h(n){var r,u;n.player.state.playerState?(r=n.player)==null||r.pause():(u=n.player)==null||u.play()}return(n,r)=>{var u,w;return d(),y("div",G,[j,x(S("input",{type:"text","onUpdate:modelValue":r[0]||(r[0]=l=>t.value=l),placeholder:"Search",class:"h-8",onInput:r[1]||(r[1]=(...l)=>p(v)&&p(v)(...l)),disabled:!((u=p(e).userSession)!=null&&u.idClient)},null,40,L),[[O,t.value]]),(w=p(e).userSession)!=null&&w.idClient?o.value?(d(),y("div",q,"Recherche...")):(d(),y("div",M,[(d(!0),y(B,null,D(i.value,l=>(d(),y("div",{key:`${l.channelId}-${l.id}`},[S("div",{url:l.thumbnails.default.url,class:"h-24 w-32 bg-no-repeat bg-center",style:Y(`background-image: url('${l.thumbnails.default.url}')`),onClick:J=>h(l)},null,12,Q),V(" "+I(l.title)+" "+I(l.player.state.playerState?"PLAYING":"")+" ",1),S("div",{id:l.videoId,class:"hidden"},null,8,H)]))),128))])):(d(),y("div",U,"You are not allowed to perform a youtube search"))])}}});export{Z as default};
